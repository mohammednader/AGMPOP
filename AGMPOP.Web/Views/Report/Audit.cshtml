@model AGMPOP.BL.Models.ViewModels.AuditSearchVM
@{
    ViewData["Title"] = "Audit";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class=" card px-3 py-1 m-0  mb-2  accordion">
    <div class="" style="overflow: visible">
        <div class="d-flex justify-content-between  "
             data-toggle="collapse"
             href="#divCollapseSearch"
             role="button"
             aria-expanded="false"
             aria-controls="divCollapseSearch"
             style="cursor: pointer">
            <h5 class="mt-2 font-weight-bold"><i class="far fa-search" style="font-size: 20px;"></i>  Search</h5>
            <span><i class="fa fa-angle-double-down " style="margin-top:10px"></i></span>

        </div>

        <div id="divCollapseSearch" class="collapse">
            <hr /><br />
            <form id="formSearchCycles">
                <input type="hidden" id="hfTerritories" name="SelectedTerritories" />

                <div class="row">
                    <div class="form-group col-sm-6 col-md-4">
                        <label asp-for="DepartmentIds"></label>
                        <select asp-for="DepartmentIds" class="mdb-select" multiple Searchable="Search here...">
                            <option class="default" value="" selected disabled>Select depatrtment</option>
                        </select>
                    </div>
                    <div class="form-group col-sm-6 col-md-4">
                        <label asp-for="Users"></label>
                        <select asp-for="Users" class="mdb-select" multiple Searchable="Search here...">
                            <option value="" selected disabled>Select user</option>
                        </select>
                    </div>

                    <div class="form-group col-sm-6 col-md-4">
                        <label asp-for="StartDate"></label>
                        <input name="startDate" class="form-control datetimepicker2" />
                    </div>

                    <div class="form-group col-sm-6 col-md-4">
                        <label asp-for="EndDate"></label>
                        <input name="endDate" class="form-control datetimepicker2" />
                    </div>
                    <div class="form-group col-sm-6 col-md-4">
                        <label asp-for="Actions"></label>
                        <select asp-for="Actions" class="mdb-select" multiple Searchable="Search here...">
                        
                        </select>
                    </div>
                    <div class="col-12 text-right">
                        <button type="button" class="btn btn-secondary px-4 m-0" onclick="clearBTN()">
                            Clear
                        </button>
                        <button type="submit" class="btn mr-0  btn-primary px-3">
                            Search
                        </button>
                    </div>
                </div>
            </form>

        </div>
    </div>
</div>
 <div id="divResult"></div>

<script>

    function getUsersPerDepart() {
        var department = $("#DepartmentIds").val();
         $('#Users').empty();
         $('#Users').append('<option  class="default" value="" selected disabled>Select Users</option>');

          $.ajax({
                url: `@Url.Action("GetAllUsers","Cycles")?department=${department}`,
              method: 'GET',
              async: false,
              success: response => {
                  console.log(response.items);
                  var data = response.items;
                  if (data) {
                      if (data && data.length) {

                          data.forEach(d => {
                              $('#Users').append(`<option value="${d.id}">${d.name}</option>`);
                          });
                      }
                  }
              }
          });
    }

     function getAllDepartments() {
        $('#DepartmentIds').empty();
        $('#DepartmentIds').append('<option  class="default" value="" selected disabled>Select Department</option>');

        $.ajax({
            url: '@Url.Action("GetAllDepartments", "Common")',
            method: 'GET',
            success: response => {
                if (response && response.length) {
                    response.forEach(j => {
                        $('#DepartmentIds').append(`<option value="${j.id}">${j.name}</option>`);
                    });
                }
            }
        });
    }

         function getAllAuditActions() {
             $('#Actions').empty();
             $('#Actions').append('<option  class="default" value="" selected disabled>Select Action</option>');

        $.ajax({
            url: '@Url.Action("GetAllAuditAction", "Common")',
            method: 'GET',
            success: response => {
                if (response && response.length) {
                    response.forEach(j => {
                        $('#Actions').append(`<option value="${j.id}">${j.name}</option>`);
                    });
                }
            }
        });
    }

    @*function getUsersPerDepart() {
        var department = $("#DepartmentIds").val();
        var $list = $("#Users");

        $list.find("option").remove();
        if (department) {
            $.ajax({
                url: `@Url.Action("GetAllUsers","Cycles")?department=${department}`,
                method: 'Get',
                success: function (res) {
                    console.log(res);
                    if (res && res.length) {
                        res.forEach(j => {
                            $('#Users').append(`<option value="${j.id}">${j.name}</option>`);
                        });
                    }
                },
                error: function (e) {
                    console.log("error" + e)
                }
            })
        }

    }*@

    function auditSearch(e) {
        if (e) {
            e.preventDefault();
            e.returnValue = false;
        }
        var form = $("#formSearchCycles").serialize();
        console.log(form);
        $.ajax({
            url: "/report/_AuditReport?" + form,
            type: "GET",
            success: (res) => {
                console.log(res);
                if (res) {
                    $("#divResult").html(res);

                }
            },

        });
    }

</script>

<script>
    $(() => {
        getAllAuditActions();
        getAllDepartments();

        $("#DepartmentIds").change(function () {
            getUsersPerDepart();
        });

        $("#formSearchCycles").on("submit", auditSearch);
    });

</script>